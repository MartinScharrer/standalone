\newif\ifstandalone
\standalonefalse

\def\sa@name{standalone}

\newcommand{\sa@documentclass}[2][]{%
  \begingroup
  \def\@tempa{#2}%
  \ifx\@tempa\sa@name
    \endgroup
    \let\document\sa@document
    \let\enddocument\sa@enddocument
    \expandafter\sa@@documentclass
  \else
    \endgroup
    \expandafter\@notprerr
  \fi
}

\def\sa@@documentclass{\sa@gobble}

\AtBeginDocument{\let\documentclass\sa@documentclass}%

\long\def\sa@gobble#1\begin#2{%
  \begingroup
  \def\@tempa{document}%
  \def\@tempb{#2}%
  \ifx\@tempa\@tempb
    \def\next{\begin{document}}%
  \else
    \def\next{\sa@gobble}%
  \fi
  \expandafter\endgroup
  \next
}

\let\sa@orig@document\document
\let\sa@orig@enddocument\enddocument

\def\document{%
  \sa@orig@document
  \let\documentclass\sa@documentclass
  \ignorespaces
}

\def\sa@document{%
  \sa@atbegindocument
}

\def\sa@enddocument{%
  \sa@atenddocument
  \aftergroup\sa@@enddocument
}

\def\sa@atbegindocument{\ignorespaces}%
\def\sa@atenddocument{\unskip}%

\def\sa@@enddocument{%
  %\let\document\sa@orig@document
  \let\enddocument\sa@orig@enddocument
  \endinput
}

\def\sa@processpreamble{%
  \renewcommand\usepackage[2][]{%
    \message{^^J%
      INFO: Sub-file requires the following package(s):^^J
      \space\space[##1]{##2}^^J%
    }%
  }%
  \let\RequirePackage\usepackage
}

%\def\sa@@documentclass{\sa@processpreamble}

